<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DTechML Preview</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #toolbar {
      display:flex; justify-content:space-between;
      background:#222; color:#fff; padding:10px;
    }
    #toolbar button {
      background:#444; color:#fff;
      border:none; padding:8px 16px;
      margin-right:5px; border-radius:4px;
      cursor:pointer;
    }
    #canvas {
      position:relative; padding:20px;
      min-height:calc(100vh - 50px);
      background:#f9f9f9; overflow:auto;
    }
    .draggable {
      position:absolute; padding:10px;
      background:#fff; border:1px solid #ccc;
      touch-action:none; cursor:move;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <div><button onclick="goBack()">‚¨Ö Editor</button></div>
    <div>
      <button onclick="goToStyle()">üé® Style</button>
      <button onclick="goToExport()">üìù Export</button>
    </div>
  </div>
  <div id="canvas"></div>

  <script>
    let commands = {};
    function parseLine(line) {
      const [cmd, rest] = line.split('=');
      if (!cmd) return {};
      const vals = [];
      let cur='', inB=false;
      for (let c of (rest||'')) {
        if (c==='{' ) inB=true;
        else if (c==='}') inB=false;
        if (c===',' && !inB) { vals.push(cur.trim()); cur=''; }
        else cur+=c;
      }
      if (cur) vals.push(cur.trim());
      return { cmd: cmd.trim(), values: vals };
    }
    fetch('html_commands.json')
      .then(r=>r.json())
      .then(data=>{
        commands=data;
        const code=localStorage.getItem('dtech_code')||'';
        const canvas=document.getElementById('canvas');
        code.split('\n').forEach(line=>{
          const {cmd,values}=parseLine(line);
          if (!commands[cmd]) return;
          let html=commands[cmd].template;
          (commands[cmd].required_fields||[]).forEach((f,i)=>{
            html=html.replace(`{${f}}`, values[i]||'');
          });
          const d=document.createElement('div');
          d.className='draggable';
          d.innerHTML=html;
          d.style.left='10px'; d.style.top='10px';
          makeDraggable(d);
          canvas.appendChild(d);
        });
      });
    function goToStyle(){ location.href='style.html'; }
    function goToExport(){ location.href='export.html'; }
    function goBack(){ location.href='faqs.html'; }

    function makeDraggable(el) {
      let offX=0,offY=0,cr=0;
      const container=document.getElementById('canvas');
      const rect=()=>container.getBoundingClientRect();
      const start=(x,y)=>{
        const er=el.getBoundingClientRect(), rc=rect();
        offX= x - er.left + container.scrollLeft - rc.left;
        offY= y - er.top  + container.scrollTop  - rc.top;
      };
      const move=(x,y)=>{
        const rc=rect();
        const rx=x-rc.left, ry=y-rc.top;
        el.style.left=(rx-offX)+'px';
        el.style.top =(ry-offY)+'px';
      };
      el.onmousedown = e=>{
        start(e.pageX,e.pageY);
        const mm=e2=>move(e2.pageX,e2.pageY);
        document.addEventListener('mousemove',mm);
        document.addEventListener('mouseup',()=>document.removeEventListener('mousemove',mm),{once:true});
      };
      el.addEventListener('touchstart',e=>{
        e.preventDefault();
        const t=e.touches[0];
        start(t.pageX,t.pageY);
        const tm=e2=>{
          const t2=e2.touches[0];
          move(t2.pageX,t2.pageY);
        };
        document.addEventListener('touchmove',tm,{passive:false});
        document.addEventListener('touchend',()=>document.removeEventListener('touchmove',tm),{once:true});
      });
    }
  </script>
</body>
</html>