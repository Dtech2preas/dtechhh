<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Beauty Showcase â€” Settings</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --danger: #ef4444;
      --danger-light: #f87171;
      --success: #10b981;
      --warning: #f59e0b;
      --card: #ffffff;
      --card-dark: #f8fafc;
      --text: #1e293b;
      --text-light: #64748b;
      --text-lighter: #94a3b8;
      --border: #e2e8f0;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f1f5f9;
      color: var(--text);
      line-height: 1.5;
    }
    
    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      position: relative;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    
    h1 {
      margin: 0 0 24px 0;
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    h1 i {
      font-size: 24px;
    }
    
    .flex {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .field {
      flex: 1;
      min-width: 220px;
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text);
    }
    
    input[type=text], 
    input[type=email], 
    input[type=number], 
    input[type=url] {
      width: 100%;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-size: 15px;
      transition: var(--transition);
      background: #f8fafc;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      background: white;
    }
    
    input:disabled {
      background: #f1f5f9;
      color: var(--text-light);
    }
    
    button {
      padding: 14px 20px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }
    
    .btn-primary:active {
      transform: translateY(0);
      background: var(--primary-dark);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: var(--danger-light);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    
    .btn-outline:hover {
      background: #f8fafc;
      border-color: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .small {
      font-size: 13px;
      color: var(--text-light);
      line-height: 1.5;
    }
    
    .status {
      margin-top: 16px;
      padding: 14px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid;
    }
    
    .status i {
      font-size: 16px;
    }
    
    .status-success {
      background: #ecfdf5;
      border-color: #a7f3d0;
      color: #065f46;
    }
    
    .status-error {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
    }
    
    .status-info {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: #1e40af;
    }
    
    .status-warning {
      background: #fffbeb;
      border-color: #fde68a;
      color: #92400e;
    }
    
    .avatar {
      width: 140px;
      height: 140px;
      border-radius: 999px;
      object-fit: cover;
      border: 3px solid var(--primary);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
      transition: var(--transition);
    }
    
    .avatar:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.2);
    }
    
    .gallery {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    
    .gallery-thumb {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: var(--transition);
    }
    
    .gallery-thumb:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .gallery-thumb.selected {
      border-color: var(--primary);
    }
    
    .gallery-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .social-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .social {
      flex: 1;
      min-width: 200px;
    }
    
    .label-inline {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
      display: block;
    }
    
    .section-title {
      margin-bottom: 12px;
      font-weight: 700;
      font-size: 16px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title i {
      color: var(--primary);
      font-size: 14px;
    }
    
    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .file-upload-btn {
      width: 100%;
      padding: 12px;
      background: #f8fafc;
      border: 1px dashed var(--border);
      border-radius: var(--radius-sm);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 8px;
    }
    
    .file-upload-btn:hover {
      background: #f1f5f9;
      border-color: var(--primary-light);
    }
    
    .file-upload-input {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f1f5f9;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .user-badge i {
      color: var(--primary);
    }
    
    .remove-thumb {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(239, 68, 68, 0.9);
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
      opacity: 0;
      transition: var(--transition);
    }
    
    .gallery-thumb:hover .remove-thumb {
      opacity: 1;
    }
    
    .divider {
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 0 16px;
      }
      
      .card {
        padding: 24px;
      }
      
      .flex, .social-row {
        gap: 16px;
      }
      
      .field, .social {
        min-width: 100%;
      }
    }
    
    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card animate-fade">
      <div class="profile-header">
        <h1><i class="fas fa-cog"></i> Profile Settings</h1>
        <div id="identityDisplay" class="user-badge">
          <i class="fas fa-user"></i>
          <span>Loading identity...</span>
        </div>
      </div>
      <div id="loginStatus" class="status status-info">
        <i class="fas fa-circle-notch fa-spin"></i>
        <span>Initializing...</span>
      </div>
    </div>

    <div class="card animate-fade" id="editProfileCard" style="animation-delay: 0.1s;">
      <div style="display: flex; gap: 32px; flex-wrap: wrap;">
        <div style="flex: 0 0 160px; text-align: center;">
          <div class="section-title">
            <i class="fas fa-user-circle"></i>
            <span>Display Picture</span>
          </div>
          <img src="" alt="avatar" id="avatarImg" class="avatar" />
          <div class="file-upload">
            <label class="file-upload-btn">
              <i class="fas fa-upload"></i> Change Photo
              <input type="file" id="changeAvatarInput" accept="image/*" class="file-upload-input" />
            </label>
          </div>
          <div class="small" style="margin-top: 12px;">JPG, PNG or GIF (Max 5MB)</div>
        </div>
        <div style="flex: 1; min-width: 260px;">
          <div class="section-title">
            <i class="fas fa-id-card"></i>
            <span>Basic Information</span>
          </div>
          <div class="flex">
            <div class="field">
              <label>Username</label>
              <input type="text" id="username" disabled/>
              <div class="small">Cannot be changed</div>
            </div>
            <div class="field">
              <label>Full Name</label>
              <input type="text" id="fullName" placeholder="Your full name" />
            </div>
            <div class="field">
              <label>Age</label>
              <input type="number" id="age" min="13" placeholder="Your age" />
            </div>
          </div>
          <div class="field">
            <label>Email Address</label>
            <input type="email" id="email" disabled placeholder="your@email.com" />
            <div class="small">Used for login, not displayed publicly</div>
          </div>
        </div>
      </div>
      
      <div class="divider"></div>
      
      <div>
        <div class="section-title">
          <i class="fas fa-share-alt"></i>
          <span>Social Media Links</span>
        </div>
        <div class="social-row">
          <div class="social">
            <label><i class="fab fa-facebook" style="color: #1877f2;"></i> Facebook</label>
            <input type="text" id="facebook" placeholder="username or profile link" />
            <div class="label-inline">Optional</div>
          </div>
          <div class="social">
            <label><i class="fab fa-tiktok" style="color: #000000;"></i> TikTok</label>
            <input type="text" id="tiktok" placeholder="@username" />
            <div class="label-inline">Optional</div>
          </div>
          <div class="social">
            <label><i class="fab fa-youtube" style="color: #ff0000;"></i> YouTube</label>
            <input type="text" id="youtube" placeholder="channel name or URL" />
            <div class="label-inline">Optional</div>
          </div>
          <div class="social">
            <label><i class="fab fa-whatsapp" style="color: #25d366;"></i> WhatsApp</label>
            <input type="text" id="whatsapp" placeholder="+1234567890" />
            <div class="label-inline">Optional</div>
          </div>
        </div>
      </div>
      
      <div class="divider"></div>

      <div>
        <div class="section-title">
          <i class="fas fa-images"></i>
          <span>Photo Gallery</span>
        </div>
        <div>
          <button id="addGalleryBtn" class="btn-outline">
            <i class="fas fa-plus"></i> Add New Picture
          </button>
          <div class="small" style="margin-top: 8px;">
            Upload additional photos to showcase your work. First image is your main display picture.
          </div>
        </div>
        <div class="gallery" id="galleryContainer"></div>
      </div>
      
      <div style="margin-top: 32px;">
        <button id="saveBtn" class="btn-primary">
          <i class="fas fa-save"></i> Save Changes
        </button>
        <div id="saveStatus" class="status status-info" style="margin-top: 12px;">
          <i class="fas fa-info-circle"></i>
          <span>All changes will be saved to your profile.</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const GIST_TOKEN_URL = "https://gist.githubusercontent.com/Dtech2preas/6750d0418aaa9dfe7f297c26d1dfae48/raw/2e511e4d11267d5aade0229849446b7297ae01c9/gistfile1.txt";
    const REPO_OWNER = "Dtech2preas", REPO_NAME = "Oratilr", DATA_FILE_PATH = "data1.json";
    const IMGBB_API_KEY = "cedf418c6d844af9c47a7775a17161a6";
    const TOKEN_TTL = 30000;

    // DOM
    const identityDisplay = document.getElementById("identityDisplay");
    const loginStatus = document.getElementById("loginStatus");
    const avatarImg = document.getElementById("avatarImg");
    const changeAvatarInput = document.getElementById("changeAvatarInput");
    const usernameInput = document.getElementById("username");
    const fullNameInput = document.getElementById("fullName");
    const ageInput = document.getElementById("age");
    const emailInput = document.getElementById("email");
    const facebookInput = document.getElementById("facebook");
    const tiktokInput = document.getElementById("tiktok");
    const youtubeInput = document.getElementById("youtube");
    const whatsappInput = document.getElementById("whatsapp");
    const galleryContainer = document.getElementById("galleryContainer");
    const addGalleryBtn = document.getElementById("addGalleryBtn");
    const saveBtn = document.getElementById("saveBtn");
    const saveStatus = document.getElementById("saveStatus");

    // STATE
    let identity = null;
    let profiles = [];
    let meProfile = null;
    let cachedToken = null;
    let tokenFetchedAt = 0;
    let latestSha = null;

    function setStatus(el, msg, type="info") {
      el.innerHTML = `<i class="fas fa-${getStatusIcon(type)}"></i><span>${msg}</span>`;
      el.className = `status status-${type}`;
    }
    
    function getStatusIcon(type) {
      switch(type) {
        case "error": return "exclamation-circle";
        case "success": return "check-circle";
        case "warning": return "exclamation-triangle";
        default: return "info-circle";
      }
    }

    function escapeHTML(s){ if(!s) return ""; return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); }

    async function timeoutFetch(url, opts={}, ms=8000) {
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), ms);
      try { return await fetch(url, {...opts, signal: controller.signal}); }
      finally { clearTimeout(id); }
    }

    async function fetchToken() {
      if (cachedToken && (Date.now() - tokenFetchedAt) < TOKEN_TTL) return cachedToken;
      try {
        const res = await timeoutFetch(GIST_TOKEN_URL);
        if (!res.ok) throw new Error("token fetch failed");
        const t = (await res.text()).trim();
        if (!t) throw new Error("empty token");
        cachedToken = t; tokenFetchedAt = Date.now();
        return t;
      } catch (e) {
        console.warn("Token fetch failure, proceeding with fallback read-only if possible:", e);
        throw e;
      }
    }

    async function getRepoFileViaAPI(token) {
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
      const res = await timeoutFetch(url, {
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: "application/vnd.github.v3+json"
        }
      });
      if (!res.ok) throw new Error(`GitHub contents API failed: ${res.status}`);
      return await res.json();
    }

    async function getRawJsonFallback() {
      const rawUrl = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${DATA_FILE_PATH}`;
      const res = await timeoutFetch(rawUrl);
      if (!res.ok) throw new Error("Fallback raw fetch failed");
      return await res.json();
    }

    async function updateRepoFile(token, sha, array) {
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
      const body = {
        message: "Update user settings",
        content: btoa(unescape(encodeURIComponent(JSON.stringify(array, null, 2)))),
        sha
      };
      const res = await timeoutFetch(url, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: "application/vnd.github.v3+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      }, 10000);
      if (!res.ok) {
        const t = await res.text();
        throw new Error("update failed: " + t);
      }
      return await res.json();
    }

    async function uploadImage(file) {
      if (file.size > 5 * 1024 * 1024) {
        throw new Error("File size exceeds 5MB limit");
      }
      
      const blob = await new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=()=>{
          const img=new Image();
          img.onload=()=>{
            const canvas=document.createElement("canvas");
            canvas.width=img.width;
            canvas.height=img.height;
            const ctx=canvas.getContext("2d");
            ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(img,0,0);
            canvas.toBlob(b=> b? resolve(b): reject("canvas failed"), "image/png");
          };
          img.onerror=()=>reject("image load error");
          img.src=reader.result;
        };
        reader.onerror=()=>reject("reader error");
        reader.readAsDataURL(file);
      });
      const base64 = await new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=> resolve(r.result.split(",")[1]);
        r.onerror=()=> reject("base64 fail");
        r.readAsDataURL(blob);
      });
      const form=new FormData();
      form.append("image", base64);
      const resp=await timeoutFetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{ method:"POST", body: form },10000);
      const j=await resp.json();
      if (!j.success) throw new Error("img upload failed");
      return j.data.url;
    }

    function loadIdentity() {
      try {
        const stored = JSON.parse(localStorage.getItem("beauty_identity")||"null");
        if (!stored || !stored.username) throw new Error("no identity");
        const today = new Date().toISOString().slice(0,10);
        if (stored.lastLikeDate !== today) {
          stored.likesToday = 0;
          stored.lastLikeDate = today;
          localStorage.setItem("beauty_identity", JSON.stringify(stored));
        }
        identity = stored;
        identityDisplay.querySelector("span").textContent = identity.anonymous
          ? `Anonymous: ${escapeHTML(identity.username)}`
          : escapeHTML(identity.username);
      } catch {
        setStatus(loginStatus, "No identity found. Redirecting to login...", "error");
        setTimeout(()=> location.href="auth.html", 1500);
        throw new Error("no identity");
      }
    }

    function renderGallery(list) {
      galleryContainer.innerHTML = "";
      (list || []).forEach((url, idx) => {
        const div = document.createElement("div");
        div.className = "gallery-thumb";
        div.dataset.idx = idx;
        div.innerHTML = `
          <img src="${escapeHTML(url)}" alt="gallery">
          <button class="remove-thumb" title="Remove image"><i class="fas fa-times"></i></button>
        `;
        galleryContainer.appendChild(div);
        div.querySelector(".remove-thumb").addEventListener("click", (e) => {
          e.stopPropagation();
          removeGalleryAt(idx);
        });
      });
    }

    function removeGalleryAt(idx) {
      if (!meProfile) return;
      meProfile.gallery = meProfile.gallery || [];
      meProfile.gallery.splice(idx,1);
      renderGallery(meProfile.gallery);
      setStatus(saveStatus, "Image removed. Save to update your profile.", "warning");
    }

    function populateForm(p) {
      usernameInput.value = p.username || "";
      fullNameInput.value = p.fullName || "";
      ageInput.value = p.age || "";
      emailInput.value = p.email || "";
      avatarImg.src = p.image || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cbd5e1'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E";
      facebookInput.value = (p.social && p.social.facebook) || "";
      tiktokInput.value = (p.social && p.social.tiktok) || "";
      youtubeInput.value = (p.social && p.social.youtube) || "";
      whatsappInput.value = (p.social && p.social.whatsapp) || "";
      renderGallery(p.gallery || []);
    }

    async function init() {
      setStatus(loginStatus, "Loading your profile...", "info");
      try {
        loadIdentity();
        
        // attempt to fetch profiles via API first
        let fileInfo;
        try {
          const token = await fetchToken();
          fileInfo = await getRepoFileViaAPI(token);
          latestSha = fileInfo.sha;
          let arr = [];
          try { arr = JSON.parse(atob(fileInfo.content)); } catch {}
          if (!Array.isArray(arr)) arr = [];
          profiles = arr;
        } catch (apiErr) {
          console.warn("API fetch failed; falling back to raw:", apiErr);
          // fallback read-only
          const arr = await getRawJsonFallback();
          if (!Array.isArray(arr)) throw new Error("Profile data invalid");
          profiles = arr;
        }

        // find my profile
        meProfile = profiles.find(p => String(p.username).toLowerCase() === String(identity.username).toLowerCase());
        if (!meProfile) {
          setStatus(loginStatus, "Profile not found for user.", "error");
          return;
        }
        
        populateForm(meProfile);
        setStatus(loginStatus, "Your profile has been loaded successfully.", "success");
      } catch (e) {
        setStatus(loginStatus, "Failed to initialize: " + e.message, "error");
      }
    }

    changeAvatarInput.addEventListener("change", async () => {
      const file = changeAvatarInput.files[0];
      if (!file) return;
      try {
        setStatus(saveStatus, "Uploading your new avatar...", "info");
        saveBtn.disabled = true;
        const url = await uploadImage(file);
        avatarImg.src = url;
        if (meProfile) meProfile.image = url;
        setStatus(saveStatus, "Avatar updated successfully. Don't forget to save!", "success");
      } catch (e) {
        setStatus(saveStatus, "Avatar upload failed: " + e.message, "error");
      } finally {
        saveBtn.disabled = false;
      }
    });

    addGalleryBtn.addEventListener("click", async () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        try {
          setStatus(saveStatus, "Uploading your gallery image...", "info");
          saveBtn.disabled = true;
          addGalleryBtn.disabled = true;
          const url = await uploadImage(file);
          meProfile.gallery = meProfile.gallery || [];
          meProfile.gallery.push(url);
          renderGallery(meProfile.gallery);
          setStatus(saveStatus, "Image added to gallery. Save to update your profile.", "success");
        } catch (e) {
          setStatus(saveStatus, "Upload failed: " + e.message, "error");
        } finally {
          saveBtn.disabled = false;
          addGalleryBtn.disabled = false;
        }
      };
      input.click();
    });

    saveBtn.addEventListener("click", async () => {
      if (!meProfile) return;
      
      setStatus(saveStatus, "Saving your changes...", "info");
      saveBtn.disabled = true;
      
      // Update profile data
      meProfile.fullName = fullNameInput.value.trim();
      meProfile.age = Number(ageInput.value) || meProfile.age;
      meProfile.social = {
        facebook: facebookInput.value.trim(),
        tiktok: tiktokInput.value.trim(),
        youtube: youtubeInput.value.trim(),
        whatsapp: whatsappInput.value.trim()
      };
      
      try {
        const token = await fetchToken();
        // re-fetch to avoid overwriting remote changes
        const fileInfo = await getRepoFileViaAPI(token);
        latestSha = fileInfo.sha;
        let arr = [];
        try { arr = JSON.parse(atob(fileInfo.content)); } catch {}
        if (!Array.isArray(arr)) arr = [];
        
        const idx = arr.findIndex(x => String(x.username).toLowerCase() === String(meProfile.username).toLowerCase());
        if (idx === -1) throw new Error("Profile missing on remote");
        
        arr[idx] = meProfile;
        await updateRepoFile(token, fileInfo.sha, arr);
        profiles = arr;
        
        setStatus(saveStatus, "Your changes have been saved successfully!", "success");
        setTimeout(() => {
          setStatus(saveStatus, "All changes saved to your profile.", "info");
        }, 3000);
      } catch (e) {
        setStatus(saveStatus, "Failed to save changes: " + e.message, "error");
      } finally {
        saveBtn.disabled = false;
      }
    });

    // Initialize the application
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>