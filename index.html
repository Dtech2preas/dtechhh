<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Webpage Copier with Local Support</title>
  <style>
    /* Basic styling for the tool interface */
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    textarea { width: 100%; height: 300px; font-family: monospace; }
    button { padding: 8px 15px; margin: 5px; }
    .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>Webpage Copier</h1>
  <input type="text" id="urlInput" placeholder="Enter URL or local path (e.g. /Sports.html)" size="50">
  <button onclick="fetchPage()">Fetch Page</button>
  <button id="downloadBtn" disabled onclick="downloadHTML()">Download HTML</button>
  
  <div id="status" class="status"></div>
  
  <textarea id="output" placeholder="Processed HTML will appear here..."></textarea>

  <script>
    let processedHTML = '';
    const proxy = "https://api.allorigins.win/raw?url=";

    async function fetchPage() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        showStatus('Please enter a URL', 'error');
        return;
      }

      try {
        showStatus('Fetching page...', 'success');
        
        // Get the HTML content
        const html = await fetchContent(url);
        
        // Process the HTML
        const finalHTML = await processHTML(html, url);
        
        // Display and enable download
        document.getElementById('output').value = finalHTML;
        processedHTML = finalHTML;
        document.getElementById('downloadBtn').disabled = false;
        showStatus('Page processed successfully!', 'success');
        
      } catch (err) {
        showStatus('Error: ' + err.message, 'error');
        console.error(err);
      }
    }

    async function fetchContent(url) {
      try {
        // Try direct fetch first (works for local files if CORS allows)
        const response = await fetch(url);
        return await response.text();
      } catch (e) {
        // Fall back to proxy for remote URLs if direct fetch fails
        if (!url.startsWith('http')) {
          throw new Error('Local file access blocked by CORS. Try running this tool locally.');
        }
        const proxyUrl = proxy + encodeURIComponent(url);
        const response = await fetch(proxyUrl);
        return await response.text();
      }
    }

    async function processHTML(html, baseUrl) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Get base path for relative URLs
      const basePath = getBasePath(baseUrl);
      
      // Process CSS
      await processCSS(doc, basePath);
      
      // Process images
      await processImages(doc, basePath);
      
      // Process other resources (scripts, etc.)
      processScripts(doc, basePath);
      
      // Ensure proper HTML structure
      return buildFinalHTML(doc);
    }

    function getBasePath(url) {
      if (url.startsWith('http')) {
        return new URL(url).origin;
      }
      // For local paths, get directory path
      const lastSlash = url.lastIndexOf('/');
      return lastSlash > 0 ? url.substring(0, lastSlash + 1) : './';
    }

    async function processCSS(doc, basePath) {
      const stylesheets = Array.from(doc.querySelectorAll('link[rel="stylesheet"]'));
      
      for (const link of stylesheets) {
        const href = link.getAttribute('href');
        if (!href) continue;
        
        try {
          const cssUrl = href.startsWith('http') ? href : basePath + href;
          const cssContent = await fetchContent(cssUrl);
          
          // Create style tag with the CSS content
          const style = document.createElement('style');
          style.textContent = cssContent;
          link.replaceWith(style);
        } catch (e) {
          console.warn('Failed to load CSS:', href, e);
          link.remove();
        }
      }
    }

    async function processImages(doc, basePath) {
      const images = Array.from(doc.querySelectorAll('img'));
      
      for (const img of images) {
        const src = img.getAttribute('src');
        if (!src) continue;
        
        try {
          const imgUrl = src.startsWith('http') ? src : basePath + src;
          const response = await fetch(imgUrl);
          const blob = await response.blob();
          
          // Convert to base64 data URL
          const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
          
          img.src = dataUrl;
        } catch (e) {
          console.warn('Failed to load image:', src, e);
        }
      }
    }

    function processScripts(doc, basePath) {
      const scripts = Array.from(doc.querySelectorAll('script[src]'));
      
      for (const script of scripts) {
        const src = script.getAttribute('src');
        if (src && !src.startsWith('http')) {
          script.src = basePath + src;
        }
      }
    }

    function buildFinalHTML(doc) {
      // Ensure proper HTML structure
      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${doc.title || 'Downloaded Page'}</title>
  ${getHeadContent(doc)}
</head>
<body>
  ${getBodyContent(doc)}
</body>
</html>`;
      
      return html;
    }

    function getHeadContent(doc) {
      const head = doc.head;
      let content = '';
      
      // Copy all elements except title (we handle that separately)
      for (const child of head.children) {
        if (child.tagName !== 'TITLE') {
          content += child.outerHTML + '\n';
        }
      }
      
      return content;
    }

    function getBodyContent(doc) {
      return doc.body.innerHTML;
    }

    function downloadHTML() {
      if (!processedHTML) return;
      
      const blob = new Blob([processedHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = getDownloadFilename();
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function getDownloadFilename() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) return 'page.html';
      
      if (url.startsWith('http')) {
        const domain = new URL(url).hostname.replace('www.', '');
        return `${domain}.html`;
      }
      
      // For local paths
      const filename = url.split('/').pop();
      return filename.endsWith('.html') ? filename : `${filename}.html`;
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }
  </script>
</body>
</html>